import Code from '../../../components/Code.jsx';

# Autenticação

## Cookie

![](/imgs/auth/cookie-data.png)

Propósito:
- Gerenciamento de sessão
- Personalização
- Rastreamento

> Alternativas: Web Storage API e IndexedDB

### Front-end (window.document.cookie)

| Ações  | Código                                                                 |
| ------ | ---------------------------------------------------------------------- |
| Create | `document.cookie = 'counter = 1'`                                      |
| Read   | `document.cookie`                                                      |
| Update | `document.cookie = 'counter = 2'`                                      |
| Delete | `document.cookie = 'counter =; Expires=Thu, 01 Jan 1970 00:00:00 GMT'` |

[RFC 6265 - HTTP State Management Mechanism](https://tools.ietf.org/html/rfc6265):

| Propriedade | Tipo              |
| ----------- | ----------------- |
| domain      | String            |
| expires     | Date              |
| httpOnly    | Boolean           |
| maxAge      | Number            |
| path        | String            |
| secure      | Boolean           |

[Chrome DevTools (View, Edit, And Delete Cookies With Chrome DevTools)](https://developers.google.com/web/tools/chrome-devtools/storage/cookies)

### Back-end (express, cookie-parser)

| Ações  | Código                                       | Referência                                                                               |
| ------ | -------------------------------------------- | ---------------------------------------------------------------------------------------- |
| Create | `res.cookie('counter', 1, {maxAge: 360000})` | [res.cookie(name, value [, options])](http://expressjs.com/en/5x/api.html#res.cookie)    |
| Read   | `req.cookies.counter`                        | [cookie-parser](https://github.com/expressjs/cookie-parser)                              |
| Update | `res.cookie('counter', 2)`                   | [res.cookie(name, value [, options])](http://expressjs.com/en/5x/api.html#res.cookie)    |
| Delete | `res.clearCookie('counter')`                 | [res.clearCookie(name [, options])](http://expressjs.com/en/5x/api.html#res.clearCookie) |

RFC 6265 - HTTP Request (Cookie), HTTP Response (Set-Cookie):

![](/imgs/auth/cookie-flow.png)

### Exemplo (Contador)

src/index.js:

<Code src="/codes/auth/cookie-counter/src/index.js" lang="js" />

[![Edit cookie-counter](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/heuristic-morning-0rksr?fontsize=14&hidenavigation=1&theme=dark)

![](/imgs/auth/cookie-counter.png)

## Session

![](/imgs/auth/session-data.png)

[Session Storage (express-session)](https://github.com/expressjs/session#compatible-session-stores):

- MemoryStore (default)
- [connect-redis](https://github.com/tj/connect-redis#readme)
- [connect-mongo](https://github.com/jdesboeufs/connect-mongo#readme)
- [connect-sqlite3](https://github.com/rawberg/connect-sqlite3#readme)

### Back-end (express-session)

[req.session (express-session)](https://github.com/expressjs/session#readme):

| Ações  | Código                       |
| ------ | ---------------------------- |
| Create | `req.session.counter = 1`    |
| Read   | `req.session.counter`        |
| Update | `req.session.counter = 2`    |
| Delete | `delete req.session.counter` |

### Exemplo (Contador)

src/index.js:

<Code src="/codes/auth/session-counter/src/index.js" lang="js" />

[![Edit session-counter](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/festive-heyrovsky-ymk52?fontsize=14&hidenavigation=1&theme=dark)

![](/imgs/auth/session-counter.png)

## Autenticação com Session

[Fluxo](/imgs/auth/auth-request.png):

![](/imgs/auth/auth-flow.png)

```text
auth-session
├── package-lock.json
├── package.json
└── src
    ├── controllers
    │   └── SessionController.js
    ├── index.js
    ├── middleware
    │   └── auth.js
    ├── routes
    │   └── index.js
    └── views
        ├── home.njk
        └── signin.njk
```

src/index.js:

<Code src="/codes/auth/auth-session/src/index.js" lang="js" />

src/routes/index.js:

<Code src="/codes/auth/auth-session/src/routes/index.js" lang="js" />

src/middleware/auth.js:

<Code src="/codes/auth/auth-session/src/middleware/auth.js" lang="js" />

src/controllers/SessionController.js:

<Code src="/codes/auth/auth-session/src/controllers/SessionController.js" lang="js" />

[![Edit session-auth](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/nice-poincare-jn9fm?fontsize=14&hidenavigation=1&theme=dark)

## Autenticação com JWT

[Token](https://jwt.io/#debugger-io?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTYzMzkxNDc3MiwiZXhwIjoxNjMzOTE1MDcyfQ.wGs4R42bIwKhTiFWVZrs-QGs_0bEWSc69rjylXj7nPE):

![](/imgs/auth/jwt-token.png)

Fluxo de Requisição:

![](/imgs/auth/jwt-request.png)


Código:

```text
auth-jwt
├── package-lock.json
├── package.json
├── public
│   ├── css
│   │   ├── bootstrap.min.css
│   │   └── bootstrap.min.css.map
│   ├── foods.html
│   ├── imgs
│   │   ├── batatafrita.jpg
│   │   ├── hamburguer.jpg
│   │   ├── milkshake.jpg
│   │   ├── sanduiche.jpg
│   │   └── suco.jpg
│   ├── js
│   │   ├── bootstrap.min.js
│   │   ├── bootstrap.min.js.map
│   │   ├── jquery.min.js
│   │   ├── popper.min.js
│   │   ├── popper.min.js.map
│   │   └── services
│   │       └── api.js
│   ├── signin.html
│   └── signup.html
├── requests.http
└── src
    ├── controllers
    │   ├── authController.js
    │   ├── categoriesController.js
    │   ├── foodsController.js
    │   └── usersController.js
    ├── db
    │   ├── database.sqlite
    │   ├── index.js
    │   ├── migration.js
    │   └── seed.js
    ├── index.js
    ├── middleware
    │   └── auth.js
    ├── migrations
    │   └── index.js
    ├── models
    │   ├── Category.js
    │   ├── Food.js
    │   └── User.js
    ├── routes
    │   └── index.js
    └── seeders
        ├── data.json
        └── index.js
```

[![Edit foods-app-auth-jwt](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/foods-app-auth-jwt-1jctq?fontsize=14&hidenavigation=1&theme=dark)

src/controllers/authController.js:

<Code src="/codes/auth/auth-jwt/src/controllers/authController.js" lang="js" />

src/middleware/auth.js:

<Code src="/codes/auth/auth-jwt/src/middleware/auth.js" lang="js" />

## Referências

- [Using HTTP cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)
- [Use cookies securely](https://expressjs.com/en/advanced/best-practice-security.html#use-cookies-securely)
- Pacotes:
  - [cookie-parser](https://github.com/expressjs/cookie-parser#readme)
  - [express-session](https://github.com/expressjs/session#readme)
  - [cookie-session](http://expressjs.com/en/resources/middleware/cookie-session.html)
  - [connect-sqlite3](https://github.com/rawberg/connect-sqlite3#readme)
  - [bcrypt](https://github.com/kelektiv/node.bcrypt.js#readme)
  - [jsonwebtoken](https://github.com/auth0/node-jsonwebtoken)
